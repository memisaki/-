{
  "bsonType": "object",
  "required": [
    "user_id",
    "content_type"
  ],
  "permission": {
    "read": "doc.visibility == 'public' || doc.user_id == auth.uid || doc.share_mode == 'friends_only' && auth.uid in doc.friend_ids",
    "create": "auth.uid != null",
    "update": "doc.user_id == auth.uid",
    "delete": "doc.user_id == auth.uid"
  },
  "properties": {
    "_id": {
      "description": "内容ID，系统自动生成"
    },
    "user_id": {
      "bsonType": "string",
      "description": "发布者ID",
      "foreignKey": "uni-id-users._id",
      "forceDefaultValue": {
        "$env": "uid"
      }
    },
    "title": {
      "bsonType": "string",
      "description": "标题",
      "title": "标题",
      "trim": "both",
      "minLength": 1,
      "maxLength": 100
    },
    "content_type": {
      "bsonType": "string",
      "description": "内容类型",
      "enum": [
        "text",
        "image",
        "video",
        "mixed"
      ],
      "defaultValue": "text"
    },
    "text_content": {
      "bsonType": "string",
      "description": "文本内容（支持富文本/HTML）",
      "title": "文本内容",
      "trim": "right"
    },
    "media_files": {
      "bsonType": "array",
      "description": "媒体文件列表（图片/视频）",
      "items": {
        "bsonType": "object",
        "required": [
          "url",
          "file_type"
        ],
        "properties": {
          "url": {
            "bsonType": "string",
            "description": "文件URL"
          },
          "file_type": {
            "bsonType": "string",
            "description": "文件类型：image/jpeg, image/png, video/mp4等"
          },
          "thumbnail": {
            "bsonType": "string",
            "description": "缩略图URL（视频需要）"
          },
          "duration": {
            "bsonType": "int",
            "description": "视频时长（秒）"
          },
          "size": {
            "bsonType": "int",
            "description": "文件大小（字节）"
          },
          "width": {
            "bsonType": "int",
            "description": "图片/视频宽度"
          },
          "height": {
            "bsonType": "int",
            "description": "图片/视频高度"
          },
          "processed": {
            "bsonType": "bool",
            "description": "是否已处理（如视频转码、敏感内容检测）",
            "defaultValue": false
          },
          "ai_analysis": {
            "bsonType": "object",
            "description": "AI分析结果",
            "properties": {
              "labels": {
                "bsonType": "array",
                "description": "AI识别的标签",
                "items": {
                  "bsonType": "string"
                }
              },
              "description": {
                "bsonType": "string",
                "description": "AI生成的描述"
              },
              "nsfw_score": {
                "bsonType": "double",
                "description": "敏感内容评分（0-1）"
              }
            }
          }
        }
      }
    },
    "tags": {
      "bsonType": "array",
      "description": "用户自定义标签",
      "title": "标签",
      "items": {
        "bsonType": "string",
        "trim": "both",
        "maxLength": 20
      }
    },
    "categories": {
      "bsonType": "array",
      "description": "分类目录",
      "foreignKey": "categories._id",
      "items": {
        "bsonType": "string"
      }
    },
    "visibility": {
      "bsonType": "string",
      "description": "可见性设置",
      "enum": [
        "public",
        "private",
        "friends_only"
      ],
      "defaultValue": "public"
    },
    "share_mode": {
      "bsonType": "string",
      "description": "分享模式",
      "enum": [
        "view_only",
        "can_comment",
        "can_download"
      ],
      "defaultValue": "view_only"
    },
    "friend_ids": {
      "bsonType": "array",
      "description": "指定好友可见的用户ID列表（当visibility为friends_only时生效）",
      "items": {
        "bsonType": "string",
        "foreignKey": "uni-id-users._id"
      }
    },
    "stats": {
      "bsonType": "object",
      "description": "内容统计信息",
      "properties": {
        "view_count": {
          "bsonType": "int",
          "description": "查看次数",
          "defaultValue": 0
        },
        "like_count": {
          "bsonType": "int",
          "description": "点赞数",
          "defaultValue": 0
        },
        "comment_count": {
          "bsonType": "int",
          "description": "评论数",
          "defaultValue": 0
        },
        "average_rating": {
          "bsonType": "double",
          "description": "平均评分（0-5）",
          "minimum": 0,
          "maximum": 5,
          "defaultValue": 0
        },
        "rating_count": {
          "bsonType": "int",
          "description": "评分人数",
          "defaultValue": 0
        },
        "share_count": {
          "bsonType": "int",
          "description": "分享次数",
          "defaultValue": 0
        },
        "download_count": {
          "bsonType": "int",
          "description": "下载次数",
          "defaultValue": 0
        }
      }
    },
    "ai_processed": {
      "bsonType": "bool",
      "description": "是否经过AI处理",
      "defaultValue": false
    },
    "ai_summary": {
      "bsonType": "string",
      "description": "AI生成的内容摘要"
    },
    "ai_tags": {
      "bsonType": "array",
      "description": "AI自动生成的标签",
      "items": {
        "bsonType": "string"
      }
    },
    "content_check": {
      "bsonType": "object",
      "description": "内容审核结果",
      "properties": {
        "status": {
          "bsonType": "string",
          "description": "审核状态：pending, passed, rejected",
          "enum": [
            "pending",
            "passed",
            "rejected"
          ],
          "defaultValue": "pending"
        },
        "sensitive_words": {
          "bsonType": "array",
          "description": "检测到的敏感词",
          "items": {
            "bsonType": "string"
          }
        },
        "check_time": {
          "bsonType": "timestamp",
          "description": "审核时间"
        },
        "reject_reason": {
          "bsonType": "string",
          "description": "拒绝原因"
        }
      }
    },
    "location": {
      "bsonType": "object",
      "description": "地理位置信息",
      "properties": {
        "name": {
          "bsonType": "string",
          "description": "地点名称"
        },
        "address": {
          "bsonType": "string",
          "description": "详细地址"
        },
        "coordinates": {
          "bsonType": "array",
          "description": "经纬度坐标 [经度, 纬度]",
          "items": {
            "bsonType": "double"
          }
        }
      }
    },
    "metadata": {
      "bsonType": "object",
      "description": "元数据",
      "properties": {
        "word_count": {
          "bsonType": "int",
          "description": "文本字数"
        },
        "reading_time": {
          "bsonType": "int",
          "description": "预计阅读时间（分钟）"
        },
        "language": {
          "bsonType": "string",
          "description": "内容语言"
        },
        "color_palette": {
          "bsonType": "array",
          "description": "主色调（针对图片/视频）",
          "items": {
            "bsonType": "string"
          }
        }
      }
    },
    "is_draft": {
      "bsonType": "bool",
      "description": "是否为草稿",
      "defaultValue": false
    },
    "scheduled_time": {
      "bsonType": "timestamp",
      "description": "定时发布时间"
    },
    "expire_time": {
      "bsonType": "timestamp",
      "description": "过期时间"
    },
    "created_at": {
      "bsonType": "timestamp",
      "description": "创建时间",
      "forceDefaultValue": {
        "$env": "now"
      }
    },
    "updated_at": {
      "bsonType": "timestamp",
      "description": "更新时间",
      "forceDefaultValue": {
        "$env": "now"
      }
    },
    "published_at": {
      "bsonType": "timestamp",
      "description": "发布时间"
    },
    "deleted_at": {
      "bsonType": "timestamp",
      "description": "删除时间（软删除）"
    }
  },
  "indexes": [
    {
      "IndexName": "idx_user_created",
      "MgoKeySchema": {
        "MgoIndexKeys": [
          {
            "Name": "user_id",
            "Direction": "1"
          },
          {
            "Name": "created_at",
            "Direction": "-1"
          }
        ]
      },
      "MgoIsUnique": false
    },
    {
      "IndexName": "idx_visibility_created",
      "MgoKeySchema": {
        "MgoIndexKeys": [
          {
            "Name": "visibility",
            "Direction": "1"
          },
          {
            "Name": "created_at",
            "Direction": "-1"
          }
        ]
      },
      "MgoIsUnique": false
    },
    {
      "IndexName": "idx_tags",
      "MgoKeySchema": {
        "MgoIndexKeys": [
          {
            "Name": "tags",
            "Direction": "1"
          }
        ]
      },
      "MgoIsUnique": false
    },
    {
      "IndexName": "idx_content_type_created",
      "MgoKeySchema": {
        "MgoIndexKeys": [
          {
            "Name": "content_type",
            "Direction": "1"
          },
          {
            "Name": "created_at",
            "Direction": "-1"
          }
        ]
      },
      "MgoIsUnique": false
    },
    {
      "IndexName": "idx_scheduled",
      "MgoKeySchema": {
        "MgoIndexKeys": [
          {
            "Name": "is_draft",
            "Direction": "1"
          },
          {
            "Name": "scheduled_time",
            "Direction": "1"
          }
        ]
      },
      "MgoIsUnique": false
    }
  ],
  "version": "1.0.0"
}