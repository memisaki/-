<template>
  <view class="upload-container">
    <!-- æ ‡é¢˜ -->
    <view class="form-item">
      <text class="label">æ ‡é¢˜ *</text>
      <input
        v-model="formData.title"
        placeholder="è¯·è¾“å…¥æ ‡é¢˜ï¼ˆæœ€å¤š30å­—ï¼‰"
        maxlength="30"
        class="input"
      />
    </view>

    <!-- æè¿° -->
    <view class="form-item">
      <text class="label">æè¿°ï¼ˆå¯é€‰ï¼‰</text>
      <textarea
        v-model="formData.description"
        placeholder="è¯·è¾“å…¥æè¿°æ–‡å­—..."
        maxlength="500"
        class="textarea"
      />
    </view>

    <!-- æ ‡ç­¾ -->
    <view class="form-item">
      <text class="label">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</text>
      <input
        v-model="rawTags"
        placeholder="å¦‚ï¼šç¾é£Ÿ,æ—…è¡Œ,æ—¥å¸¸"
        class="input"
      />
    </view>

    <!-- å†…å®¹ç±»å‹é€‰æ‹© -->
    <view class="form-item">
      <text class="label">å†…å®¹ç±»å‹ *</text>
      <view class="type-selector">
        <button
          :class="{ active: formData.type === 'text' }"
          @click="setContentType('text')"
        >
          çº¯æ–‡æœ¬
        </button>
        <button
          :class="{ active: formData.type === 'image' }"
          @click="setContentType('image')"
        >
          å›¾ç‰‡
        </button>
        <button
          :class="{ active: formData.type === 'video' }"
          @click="setContentType('video')"
        >
          è§†é¢‘
        </button>
      </view>
    </view>

    <!-- åª’ä½“ä¸Šä¼ åŒºåŸŸ -->
    <view v-if="formData.type !== 'text'" class="media-upload">
      <button @click="selectMedia" class="upload-btn">
        {{ formData.type === 'image' ? 'é€‰æ‹©å›¾ç‰‡' : 'é€‰æ‹©è§†é¢‘' }}
      </button>

      <!-- é¢„è§ˆ -->
      <view v-if="previewUrl" class="preview">
        <image
          v-if="formData.type === 'image'"
          :src="previewUrl"
          mode="aspectFit"
          class="preview-media"
        />
        <video
          v-else-if="formData.type === 'video'"
          :src="previewUrl"
          controls
          class="preview-media"
        ></video>
      </view>

      <text v-if="mediaError" class="error">{{ mediaError }}</text>
    </view>

    <!-- æäº¤æŒ‰é’® -->
    <button @click="submitPost" :disabled="isSubmitting" class="submit-btn">
      {{ isSubmitting ? 'å‘å¸ƒä¸­...' : 'å‘å¸ƒå†…å®¹' }}
    </button>
  </view>
</template>

<script setup lang="uts">
// âœ… å…¨å±€å¯ç”¨ï¼Œæ— éœ€ import
const formData = ref({
  title: '',
  description: '',
  type: 'text',
  mediaLocalPath: '',
  mediaUrl: '',
  tags: [] as string[]
})

const rawTags = ref('')
const previewUrl = ref('')
const mediaError = ref('')
const isSubmitting = ref(false)

// è‡ªåŠ¨å¤„ç†æ ‡ç­¾
watch(() => rawTags.value, (newVal) => {
  if (!newVal) {
    formData.value.tags = []
    return
  }
  const tags = newVal
    .split(',')
    .map(t => t.trim())
    .filter(t => t)
    .slice(0, 5)
  formData.value.tags = [...new Set(tags)]
})

function setContentType(type: string) {
  formData.value.type = type
  formData.value.mediaLocalPath = ''
  formData.value.mediaUrl = ''
  previewUrl.value = ''
  mediaError.value = ''
}

async function selectMedia() {
  try {
    mediaError.value = ''

    if (formData.value.type === 'image') {
      // âœ… ä½¿ç”¨ uni.chooseImageï¼ˆæ”¯æŒï¼‰
      const res = await uni.chooseImage({ count: 1, sizeType: ['compressed'] })
      if (res.tempFilePaths.length === 0) return

      const tempPath = res.tempFilePaths[0]
      previewUrl.value = tempPath
      formData.value.mediaLocalPath = tempPath

    } else if (formData.value.type === 'video') {
      // âœ… ä½¿ç”¨ uni.chooseVideoï¼ˆæ”¯æŒï¼‰
      const res = await uni.chooseVideo({
        maxDuration: 60,
        camera: 'back'
      })

      if (res.duration > 60) {
        mediaError.value = 'è§†é¢‘æ—¶é•¿ä¸èƒ½è¶…è¿‡60ç§’'
        return
      }

      previewUrl.value = res.tempFilePath
      formData.value.mediaLocalPath = res.tempFilePath
    }
  } catch (err) {
    console.error('é€‰æ‹©åª’ä½“å¤±è´¥:', err)
    mediaError.value = 'é€‰æ‹©å¤±è´¥ï¼Œè¯·é‡è¯•'
  }
}

// âœ… ç›´æ¥ä¸Šä¼ ï¼Œä¸å†å‹ç¼©
async function uploadToAliyun(localPath: string, fileType: string): Promise<string> {
  const timestamp = Date.now()
  const extMatch = localPath.match(/\.([^.]+)$/i)
  const ext = extMatch ? extMatch[1].toLowerCase() : 'jpg'

  const userId = 'anonymous'
  const cloudPath = `posts/${fileType}/${userId}_${timestamp}.${ext}`

  try {
    const res = await uniCloud.uploadFile({
      filePath: localPath,
      cloudPath: cloudPath,
      onUploadProgress(progressEvent) {
        const percent = Math.round((progressEvent.loaded * 100) / progressEvent.total)
        console.log('ä¸Šä¼ è¿›åº¦:', percent + '%')
      }
    })

    if (res.fileID) {
      return res.fileID // è¿”å› CDN URL
    } else {
      throw new Error(res.errorMessage || 'ä¸Šä¼ å¤±è´¥')
    }
  } catch (err) {
    console.error('ä¸Šä¼ å¤±è´¥:', err)
    throw new Error('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•')
  }
}

async function submitPost() {
  if (!formData.value.title.trim()) {
    uni.showToast({ title: 'è¯·è¾“å…¥æ ‡é¢˜', icon: 'none' })
    return
  }

  if (formData.value.type !== 'text' && !formData.value.mediaLocalPath) {
    uni.showToast({ title: 'è¯·ä¸Šä¼ åª’ä½“æ–‡ä»¶', icon: 'none' })
    return
  }

  isSubmitting.value = true

  try {
    let mediaUrl = ''

    if (formData.value.type !== 'text') {
      mediaUrl = await uploadToAliyun(
        formData.value.mediaLocalPath,
        formData.value.type
      )
    }

    const postData = {
      title: formData.value.title.trim(),
      description: formData.value.description.trim(),
      type: formData.value.type,
      mediaUrl: mediaUrl,
      tags: formData.value.tags
    }

    // ğŸ‘‡ã€éœ€è¦åç«¯ APIã€‘ï¼šå‘å¸ƒå†…å®¹åˆ°ä½ çš„æœåŠ¡å™¨
    /*
    const response = await uni.request({
      url: 'https://your-api.com/posts/create',
      method: 'POST',
      data: postData
    })

    if (response.statusCode === 200) {
      uni.showToast({ title: 'å‘å¸ƒæˆåŠŸï¼', icon: 'success' })
      setTimeout(() => uni.navigateBack(), 1500)
    } else {
      throw new Error('å‘å¸ƒå¤±è´¥')
    }
    */

    // âœ… æ¨¡æ‹ŸæˆåŠŸ
    console.log('âœ… æ¨¡æ‹Ÿå‘å¸ƒæˆåŠŸ:', postData)
    uni.showToast({ title: 'å‘å¸ƒæˆåŠŸï¼', icon: 'success' })
    setTimeout(() => uni.navigateBack(), 1500)

  } catch (err) {
    console.error('å‘å¸ƒå¤±è´¥:', err)
    uni.showToast({ title: err.message || 'å‘å¸ƒå¤±è´¥', icon: 'none' })
  } finally {
    isSubmitting.value = false
  }
}
</script>

<style scoped>
/* æ ·å¼ä¿æŒä¸å˜ */
.upload-container {
  padding: 30rpx;
  background-color: #f8f9fa;
  min-height: 100vh;
}

.form-item {
  margin-bottom: 40rpx;
}

.label {
  display: block;
  font-size: 28rpx;
  color: #333;
  margin-bottom: 16rpx;
  font-weight: bold;
}

.input {
  width: 100%;
  padding: 20rpx;
  border: 1rpx solid #ddd;
  border-radius: 12rpx;
  font-size: 28rpx;
  background: white;
}

.textarea {
  width: 100%;
  height: 200rpx;
  padding: 20rpx;
  border: 1rpx solid #ddd;
  border-radius: 12rpx;
  font-size: 28rpx;
  background: white;
  line-height: 1.5;
}

.type-selector {
  display: flex;
  gap: 20rpx;
}

.type-selector button {
  flex: 1;
  padding: 16rpx 0;
  font-size: 26rpx;
  background-color: #f0f0f0;
  color: #333;
  border-radius: 12rpx;
}

.type-selector button.active {
  background-color: #007aff;
  color: white;
}

.media-upload {
  margin-top: 20rpx;
}

.upload-btn {
  background-color: #007aff;
  color: white;
  padding: 20rpx;
  border-radius: 12rpx;
  font-size: 28rpx;
}

.preview {
  margin-top: 20rpx;
  text-align: center;
}

.preview-media {
  width: 100%;
  height: 400rpx;
  background-color: #eee;
  border-radius: 12rpx;
}

.error {
  color: red;
  font-size: 24rpx;
  margin-top: 10rpx;
  display: block;
}

.submit-btn {
  width: 100%;
  padding: 24rpx;
  background-color: #007aff;
  color: white;
  font-size: 32rpx;
  border-radius: 16rpx;
  margin-top: 60rpx;
}

.submit-btn:disabled {
  background-color: #ccc;
}
</style>