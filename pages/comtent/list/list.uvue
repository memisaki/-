<template>
  <view class="container">
    <!-- é¡¶éƒ¨å¯¼èˆªæŒ‰é’® -->
	<!--
    <view class="top-nav">
      <view class="nav-btn" @click="goUpload">ä¸Šä¼ </view>
      <view class="nav-btn" @click="goProfile">ä¸ªäººä¸­å¿ƒ</view>
    </view>
	-->

    <!-- æœç´¢æ åŒºåŸŸ -->
    <view class="search-bar">
      <input
        type="text"
        v-model="keyword"
        placeholder="æœç´¢æ ‡é¢˜æˆ–æè¿°..."
        @confirm="onSearch"
      />
      <button @click="showFilterModal">ç­›é€‰</button>
    </view>

    <!-- ç­›é€‰å¼¹çª— -->
    <view v-if="showFilter" class="filter-modal">
      <!-- æ‰‹åŠ¨è¾“å…¥æ ‡ç­¾ -->
      <view class="filter-item">
        <text>æŒ‰æ ‡ç­¾ç­›é€‰ï¼š</text>
        <input
          type="text"
          v-model="manualTagInput"
          placeholder="å¦‚ï¼šç¾é£Ÿ,æ—…è¡Œï¼ˆå›è½¦åº”ç”¨ï¼‰"
          @confirm="applyFilters"
          style="flex: 1; margin-left: 20rpx; padding: 10rpx; border: 1rpx solid #ddd; border-radius: 10rpx;"
        />
      </view>

      <view class="filter-item">
        <text>æŒ‰ç±»å‹ç­›é€‰ï¼š</text>
        <picker @change="onTypeChange" :value="selectedTypeIndex" :range="types">
          <text>{{ types[selectedTypeIndex] }}</text>
        </picker>
      </view>
      <view class="filter-item">
        <text>æŒ‰æ—¥æœŸèŒƒå›´ï¼š</text>
        <picker @change="onDateRangeChange" :value="dateRangeIndex" :range="dateRanges">
          <text>{{ dateRanges[dateRangeIndex] }}</text>
        </picker>
      </view>
      <button @click="applyFilters">åº”ç”¨ç­›é€‰</button>
      <button @click="closeFilter">å–æ¶ˆ</button>
    </view>

    <!-- ä»…çœ‹è‡ªå·±æŒ‰é’® -->
    <view class="self-only-toggle">
      <button @click="toggleSelfOnly" :class="{ active: showOnlyMine }">
        {{ showOnlyMine ? 'å–æ¶ˆä»…çœ‹è‡ªå·±' : 'ä»…çœ‹è‡ªå·±' }}
      </button>
    </view>

    <!-- å†…å®¹åˆ—è¡¨ -->
    <scroll-view scroll-y class="content-list" @scrolltolower="onScrollToLower">
      <view v-for="(item, index) in filteredPosts" :key="item.id" class="post-item">
        <!-- å¤´éƒ¨ï¼šå¤´åƒ + ä½œè€… + æ ‡é¢˜ + æ—¶é—´ -->
        <view class="post-header">
          <!-- å¤´åƒ + æ˜µç§° -->
          <view class="author-line">
            <view class="avatar-container">
              <image :src="item.avatarUrl" mode="aspectFill" class="avatar"></image>
            </view>
            <text class="post-author">{{ item.author }}</text>
          </view>
        
          <!-- æ ‡é¢˜ -->
          <text class="post-title">{{ item.title }}</text>
        
          <!-- æ—¶é—´ -->
          <text class="post-time">{{ item.createdAt }}</text>
        </view>

        <!-- æè¿°æ–‡å­— -->
        <view v-if="item.description" class="post-description">
          {{ item.description }}
        </view>

        <!-- åª’ä½“åŒºåŸŸ -->
        <view v-if="item.type === 'image' || item.type === 'video'" class="media-container">
          <image v-if="item.type === 'image'" :src="item.mediaUrl" mode="aspectFill" class="media-image"></image>
          <video v-else-if="item.type === 'video'" :src="item.mediaUrl" class="media-video" controls></video>
        </view>

        <view class="post-footer">
          <text class="stat-item">ğŸ‘ï¸ {{ item.views }} æµè§ˆ</text>
          <text class="stat-item">ğŸ‘ {{ item.likes }} ç‚¹èµ</text>
          <text class="stat-item">ğŸ’¬ {{ item.comments }} è¯„è®º</text>
        </view>

        <view v-if="isMyPost(item)" class="post-actions">
          <button @click="editPost(item)">ç¼–è¾‘</button>
          <button @click="confirmDelete(item)">åˆ é™¤</button>
        </view>

        <navigator :url="'/pages/comtent/detail/detail?id=' + item.id" class="post-link">
          <text class="detail-link">æŸ¥çœ‹è¯¦æƒ…</text>
        </navigator>
      </view>

      <!-- åŠ è½½æç¤º -->
      <view v-if="loading && posts.length > 0" class="loading-more">åŠ è½½ä¸­...</view>
      <view v-else-if="!hasMore && posts.length > 0" class="no-more">æ²¡æœ‰æ›´å¤šå†…å®¹äº†</view>
      <view v-else-if="posts.length === 0 && !loading" class="empty-tips">æš‚æ— å†…å®¹</view>
    </scroll-view>

    <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <view v-if="showDeleteConfirm" class="delete-confirm">
      <text>ç¡®å®šè¦åˆ é™¤è¿™æ¡å†…å®¹å—ï¼Ÿ</text>
      <button @click="deletePost">ç¡®è®¤</button>
      <button @click="cancelDelete">å–æ¶ˆ</button>
    </view>
  </view>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { onLoad } from '@dcloudio/uni-app'

// ===== æ•°æ®çŠ¶æ€ =====
const posts = ref([])
const loading = ref(false)
const hasMore = ref(true)
const currentPage = ref(1)
const total = ref(0)

// ç”¨æˆ· ID
const myUserId = ref('')

// ===== ç­›é€‰çŠ¶æ€ =====
const showOnlyMine = ref(false)
const keyword = ref('')
const manualTagInput = ref('') // â† æ–°å¢ï¼šæ‰‹åŠ¨è¾“å…¥æ ‡ç­¾
const selectedTypeIndex = ref(0)
const dateRangeIndex = ref(3) // é»˜è®¤â€œå…¨éƒ¨â€

// ===== é€‰é¡¹åˆ—è¡¨ =====
const types = ref(['å…¨éƒ¨', 'å›¾ç‰‡', 'è§†é¢‘', 'æ–‡æœ¬'])
const dateRanges = ref(['æœ€è¿‘7å¤©', 'æœ€è¿‘30å¤©', 'è¿‘3ä¸ªæœˆ', 'å…¨éƒ¨'])

// å¼¹çª—æ§åˆ¶
const showFilter = ref(false)
const showDeleteConfirm = ref(false)
const currentPostToDelete = ref(null)

// ===== è®¡ç®—å±æ€§ =====
const filteredPosts = computed(() => {
  return posts.value
})

// ===== ç”Ÿå‘½å‘¨æœŸ =====
onMounted(async () => {
  const token = uni.getStorageSync('uni_id_token')
  const rawStorage = uni.getStorageSync('user_info')
  const user_info = rawStorage?.userInfo || rawStorage || {}
  console.log('ã€List é¡µé¢ã€‘token å­˜åœ¨?', !!token)
  console.log('ã€List é¡µé¢ã€‘user_info:', user_info)
  console.log('ã€List é¡µé¢ã€‘user_info._id:', user_info?._id)
  if (user_info?._id) {
    myUserId.value = user_info._id
  }else{
	  console.warn('âš ï¸ æœªè·å–åˆ°ç”¨æˆ· ID')
  }
  
  await fetchPosts(true)
})

// ===== è·å–å†…å®¹åˆ—è¡¨ =====
async function fetchPosts(reset = true) {
  if (!hasMore.value && !reset) return
  if (loading.value) return

  loading.value = true
  if (reset) {
    currentPage.value = 1
    posts.value = []
  } else {
    currentPage.value++
  }

  try {
    // è§£ææ ‡ç­¾è¾“å…¥ï¼šæ”¯æŒé€—å·åˆ†éš”ï¼Œè‡ªåŠ¨å»ç©ºæ ¼ã€å»é‡ã€è¿‡æ»¤ç©ºå€¼
    let tagsArray = []
    if (manualTagInput.value.trim()) {
      tagsArray = manualTagInput.value
        .split(',')
        .map(t => t.trim())
        .filter(t => t !== '')
    }

    const params = {
      page: currentPage.value,
      page_size: 10,
      keyword: keyword.value.trim(),
      content_type: '',
      tags: tagsArray, // â† ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„æ ‡ç­¾æ•°ç»„
      start_date: '',
      end_date: ''
    }

    // ç±»å‹
    if (selectedTypeIndex.value > 0) {
      const typeMap = { 'å›¾ç‰‡': 'image', 'è§†é¢‘': 'video', 'æ–‡æœ¬': 'text' }
      params.content_type = typeMap[types.value[selectedTypeIndex.value]] || ''
    }

    // æ—¥æœŸèŒƒå›´
    const now = new Date()
    let startDate = null
    let endDate = null

    if (dateRangeIndex.value === 0) {
      startDate = new Date(now.getTime() - 7 * 24 * 3600 * 1000)
      endDate = now
    } else if (dateRangeIndex.value === 1) {
      startDate = new Date(now.getTime() - 30 * 24 * 3600 * 1000)
      endDate = now
    } else if (dateRangeIndex.value === 2) {
      startDate = new Date(now.getTime() - 90 * 24 * 3600 * 1000)
      endDate = now
    }

    if (startDate) {
      params.start_date = formatDateISO(startDate)
    }
    if (endDate) {
      params.end_date = formatDateISO(endDate)
    }

    // ä»…çœ‹è‡ªå·±
    if (showOnlyMine.value && myUserId.value) {
      params.user_id = myUserId.value
    }
	
	console.log('ã€å‘é€ç»™åç«¯çš„å‚æ•°ã€‘', params)

    const res = await uniCloud.callFunction({
      name: 'content-api',
      data: {
        action: 'get',
        ...params
      }
    })
	
	console.log('ã€åç«¯åŸå§‹è¿”å›ã€‘:', res.result)

    const { code, data } = res.result
    if (code === 200) {
      const list = (data?.list || []).map(item => ({
        id: item._id,
        title: item.title || 'æ— æ ‡é¢˜',
        description: item.text_content || '',
        author: item.user_info?.nickname || 'åŒ¿å', // âœ… ä» user_info å– nickname
        createdAt: formatDate(item.created_at),
        type: item.content_type || 'text',
        mediaUrl: item.media_files?.[0]?.url || '',
        views: item.stats?.view_count || 0,
        likes: item.stats?.like_count || 0,
        comments: item.stats?.comment_count || 0,
        tags: item.tags || [],
        isMine: item.user_id === myUserId.value,
        avatarUrl: item.avatar || 'https://picsum.photos/100/100?random=' + Math.floor(Math.random() * 100)
      }))

      if (reset) {
        posts.value = list
      } else {
        posts.value.push(...list)
      }

      total.value = data?.pagination?.total || 0
      hasMore.value = posts.value.length < total.value
    } else {
      uni.showToast({ title: res.result.message || 'åŠ è½½å¤±è´¥', icon: 'none' })
    }
  } catch (err) {
    console.error('[è·å–å†…å®¹åˆ—è¡¨å¤±è´¥]', err)
    uni.showToast({ title: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', icon: 'none' })
  } finally {
    loading.value = false
  }
}

// å·¥å…·å‡½æ•°
function formatDate(dateStr) {
  if (!dateStr) return ''
  const d = new Date(dateStr)
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`
}

function formatDateISO(date) {
  return date.toISOString().split('T')[0]
}

// ===== äº¤äº’æ–¹æ³• =====
function goUpload() {
  uni.switchTab({ url: '/pages/comtent/upload/upload' })
}
function goProfile() {
  uni.switchTab({ url: '/pages/user/profile/profile' })
}

function onSearch() {
  fetchPosts(true)
}

function showFilterModal() {
  showFilter.value = true
}
function closeFilter() {
  showFilter.value = false
}
function applyFilters() {
  closeFilter()
  fetchPosts(true)
}

function onTypeChange(e) {
  selectedTypeIndex.value = e.detail.value
}
function onDateRangeChange(e) {
  dateRangeIndex.value = parseInt(e.detail.value)
  console.log('ã€æ—¥æœŸç´¢å¼•å·²æ›´æ–°ä¸ºã€‘', dateRangeIndex.value, typeof dateRangeIndex.value)
}

function toggleSelfOnly() {
  showOnlyMine.value = !showOnlyMine.value
  fetchPosts(true)
}

function isMyPost(post) {
  return post.isMine
}

function editPost(post) {
  uni.navigateTo({
    url: `/pages/content/edit/edit?id=${post.id}`
  })
}

function confirmDelete(post) {
  currentPostToDelete.value = post
  showDeleteConfirm.value = true
}

async function deletePost() {
  const post = currentPostToDelete.value
  if (!post) return

  try {
    uni.showLoading({ title: 'åˆ é™¤ä¸­...' })
    const res = await uniCloud.callFunction({
      name: 'content-api',
      data: {
        action: 'delete',
        content_id: post.id
      }
    })

    if (res.result.code === 200) {
      uni.showToast({ title: 'åˆ é™¤æˆåŠŸ', icon: 'success' })
      fetchPosts(true)
    } else {
      uni.showToast({ title: res.result.message || 'åˆ é™¤å¤±è´¥', icon: 'none' })
    }
  } catch (err) {
    console.error('[åˆ é™¤å¤±è´¥]', err)
    uni.showToast({ title: 'åˆ é™¤å¤±è´¥', icon: 'none' })
  } finally {
    uni.hideLoading()
    cancelDelete()
  }
}

function cancelDelete() {
  showDeleteConfirm.value = false
  currentPostToDelete.value = null
}

function onScrollToLower() {
  if (hasMore.value && !loading.value) {
    fetchPosts(false)
  }
}
</script>

<style scoped>
.container {
  display: flex;
  flex-direction: column;
  height: 100vh;
  background-color: #f8f9fa;
  box-sizing: border-box;
  padding: 120rpx 40rpx 40rpx; /* ä¸Šã€å·¦å³ã€ä¸‹ */
}

.top-nav {
  display: flex;
  justify-content: space-between;
  margin-bottom: 30rpx;
  padding: 0 10rpx;
  position: relative;
  z-index: 999;
  background-color: #f8f9fa;
}
.nav-btn {
  flex: 1;
  text-align: center;
  line-height: 60rpx;
  background-color: #007aff;
  color: white;
  border-radius: 30rpx;
  font-size: 28rpx;
  margin: 0 10rpx;
  user-select: none;
}

.search-bar {
  display: flex;
  align-items: center;
  margin-bottom: 30rpx;
}
.search-bar input {
  flex: 1;
  padding: 15rpx 20rpx;
  border: 1rpx solid #ddd;
  border-radius: 30rpx;
  font-size: 28rpx;
}
.search-bar button {
  margin-left: 20rpx;
  padding: 10rpx 20rpx;
  background-color: #007aff;
  color: white;
  border-radius: 30rpx;
  font-size: 28rpx;
}

.filter-modal {
  background: white;
  padding: 30rpx;
  border-radius: 20rpx;
  margin-bottom: 30rpx;
  box-shadow: 0 4rpx 20rpx rgba(0,0,0,0.1);
}
.filter-item {
  margin-bottom: 20rpx;
  display: flex;
  align-items: center;
  gap: 20rpx;
}

.self-only-toggle {
  margin-bottom: 30rpx;
  text-align: center;
}
.self-only-toggle button {
  padding: 10rpx 30rpx;
  background-color: #eaeaea;
  color: #333;
  border-radius: 20rpx;
  font-size: 28rpx;
}
.self-only-toggle button.active {
  background-color: #007aff;
  color: white;
}

.content-list {
  flex: 1;
  overflow-y: auto;
  min-height: 0;
}

.post-item {
  background: white;
  border-radius: 20rpx;
  padding: 30rpx;
  margin-bottom: 30rpx;
  box-shadow: 0 2rpx 12rpx rgba(0,0,0,0.05);
}

.post-header {
  display: flex;
  align-items: flex-start;
  gap: 20rpx;
}

.avatar-container {
  width: 60rpx;
  height: 60rpx;
  border-radius: 50%;
  overflow: hidden;
  background-color: #eee;
}

.avatar {
  width: 100%;
  height: 100%;
}

.post-author {
  font-weight: bold;
  color: #333;
}

.post-title {
  margin-top: 4rpx;
  color: #555;
  font-size: 32rpx;
}

.post-time {
  margin-top: 4rpx;
  font-size: 24rpx;
  color: #999;
}

.post-description {
  font-size: 28rpx;
  line-height: 1.6;
  color: #555;
  padding: 20rpx;
  background-color: #f9f9f9;
  border-radius: 10rpx;
  margin-bottom: 20rpx;
}

.media-container {
  width: 100%;
  height: 300rpx;
  margin-bottom: 20rpx;
  border-radius: 10rpx;
  overflow: hidden;
}
.media-image {
  width: 100%;
  height: 100%;
}
.media-video {
  width: 100%;
  height: 100%;
}

.post-footer {
  display: flex;
  justify-content: space-between;
  font-size: 24rpx;
  color: #666;
  margin-bottom: 20rpx;
}
.post-actions {
  display: flex;
  gap: 20rpx;
  margin-bottom: 20rpx;
}
.post-actions button {
  padding: 10rpx 20rpx;
  background-color: #f0f0f0;
  color: #333;
  border-radius: 20rpx;
  font-size: 24rpx;
}
.post-link {
  text-align: center;
  color: #007aff;
  font-size: 28rpx;
  text-decoration: none;
}

.loading-more, .no-more, .empty-tips {
  text-align: center;
  padding: 30rpx;
  color: #999;
  font-size: 28rpx;
}

.delete-confirm {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 40rpx;
  border-radius: 20rpx;
  box-shadow: 0 10rpx 30rpx rgba(0,0,0,0.2);
  text-align: center;
  z-index: 1000;
}
.delete-confirm button {
  margin-top: 20rpx;
  padding: 15rpx 30rpx;
  border: none;
  border-radius: 20rpx;
  font-size: 28rpx;
  width: 100%;
}
.delete-confirm button:first-child {
  background-color: #007aff;
  color: white;
}
.delete-confirm button:last-child {
  background-color: #ccc;
  color: #333;
  margin-top: 10rpx;
}
</style>