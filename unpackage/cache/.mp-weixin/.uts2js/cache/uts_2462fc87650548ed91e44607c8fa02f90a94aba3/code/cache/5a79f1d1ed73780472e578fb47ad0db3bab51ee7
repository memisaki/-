{"code":"import { __awaiter } from \"tslib\";\nimport { defineComponent } from \"vue\";\nexport default defineComponent({\n    data() {\n        return {\n            userInfo: new UTSJSONObject({\n                _id: '',\n                username: '',\n                nickname: '',\n                avatar: '',\n                gender: 0,\n                email: '',\n                mobile: '',\n                register_date: ''\n            }),\n            userStats: new UTSJSONObject({\n                content_count: 0,\n                comment_count: 0,\n                like_count: 0\n            }),\n            loading: true,\n            isUpdating: false,\n            defaultAvatar: 'https://ruangong-dazuoye-file.oss-cn-shenzhen.aliyuncs.com/%E9%AB%98%E9%9B%85%E4%BC%81%E9%B9%85.jpg',\n            genderOptions: [\n                new UTSJSONObject({ value: 0, label: '未知' }),\n                new UTSJSONObject({ value: 1, label: '男' }),\n                new UTSJSONObject({ value: 2, label: '女' })\n            ]\n        };\n    },\n    onLoad() {\n        const token = uni.getStorageSync('uni_id_token');\n        uni.__f__('log', 'at pages/user/profile/profile.uvue:130', '【当前 token】:', UTS.JSON.stringify(token)); // 用 JSON.stringify 看清结构\n        this.fetchUserInfo();\n    },\n    onPullDownRefresh() {\n        this.fetchUserInfo();\n    },\n    computed: {\n        // 用于 picker 的当前索引（解决 picker value 必须是 index 的问题）\n        getCurrentGenderIndex() {\n            const index = this.genderOptions.findIndex(opt => { return opt.value === this.userInfo.gender; });\n            return index === -1 ? 0 : index;\n        }\n    },\n    methods: {\n        fetchUserInfo() {\n            return __awaiter(this, void 0, void 0, function* () {\n                this.loading = true;\n                try {\n                    const res = yield uniCloud.callFunction({\n                        name: 'user-api',\n                        data: new UTSJSONObject({\n                            action: 'get_profile'\n                        })\n                    });\n                    const result = res.result || new UTSJSONObject({});\n                    if (result.code === 200 && result.data) {\n                        const data = result.data;\n                        // 分离 userInfo 和 stats（假设后端返回 { profile: {...}, stats: {...} } 或直接合并）\n                        // 这里兼容两种结构：1. data 是完整用户对象；2. data = { profile, stats }\n                        if (data.profile) {\n                            this.userInfo = Object.assign({}, data.profile);\n                            this.userStats = Object.assign({}, data.stats) || {};\n                        }\n                        else {\n                            // 假设 data 就是用户对象，stats 需单独处理（若无则保持默认0）\n                            this.userInfo = Object.assign({}, data);\n                            // 如果后端未返回 stats，则保持原有默认值（0）\n                        }\n                        if (!this.userInfo.avatar) {\n                            this.userInfo.avatar = this.defaultAvatar;\n                        }\n                    }\n                    else {\n                        throw new Error(result.message || '获取用户信息失败');\n                    }\n                }\n                catch (err) {\n                    uni.__f__('error', 'at pages/user/profile/profile.uvue:179', '获取用户信息异常:', err);\n                    uni.showToast({\n                        title: '获取信息失败，请重试',\n                        icon: 'none',\n                        duration: 2000\n                    });\n                }\n                finally {\n                    this.loading = false;\n                    uni.stopPullDownRefresh();\n                }\n            });\n        },\n        updateNickname() {\n            return __awaiter(this, void 0, void 0, function* () {\n                const newNickname = (this.userInfo.nickname || '').trim();\n                if (!newNickname) {\n                    uni.showToast({ title: '昵称不能为空', icon: 'none' });\n                    return Promise.resolve(null);\n                }\n                this.isUpdating = true;\n                try {\n                    const res = yield uniCloud.callFunction({\n                        name: 'user-api',\n                        data: new UTSJSONObject({\n                            action: 'profile',\n                            nickname: newNickname\n                        })\n                    });\n                    const result = res.result || new UTSJSONObject({});\n                    if (result.code === 0) {\n                        uni.showToast({ title: '昵称更新成功', icon: 'success' });\n                    }\n                    else {\n                        uni.showToast({ title: result.message || '更新失败', icon: 'none' });\n                    }\n                }\n                catch (err) {\n                    uni.__f__('error', 'at pages/user/profile/profile.uvue:215', '更新昵称失败:', err);\n                    uni.showToast({ title: '网络错误，请重试', icon: 'none' });\n                }\n                finally {\n                    this.isUpdating = false;\n                }\n            });\n        },\n        onGenderChange(e = null) {\n            return __awaiter(this, void 0, void 0, function* () {\n                const selectedIndex = e.detail.value;\n                const newGender = this.genderOptions[selectedIndex].value;\n                if (newGender === this.userInfo.gender)\n                    return Promise.resolve(null);\n                this.isUpdating = true;\n                try {\n                    const res = yield uniCloud.callFunction({\n                        name: 'user-api',\n                        data: new UTSJSONObject({\n                            action: 'update_profile',\n                            gender: newGender\n                        })\n                    });\n                    const result = res.result || new UTSJSONObject({});\n                    if (result.code === 0) {\n                        this.userInfo.gender = newGender;\n                        uni.showToast({ title: '性别更新成功', icon: 'success' });\n                    }\n                    else {\n                        uni.showToast({ title: result.message || '更新失败', icon: 'none' });\n                    }\n                }\n                catch (err) {\n                    uni.__f__('error', 'at pages/user/profile/profile.uvue:246', '更新性别失败:', err);\n                    uni.showToast({ title: '网络错误，请重试', icon: 'none' });\n                }\n                finally {\n                    this.isUpdating = false;\n                }\n            });\n        },\n        getGenderLabel(gender = null) {\n            const option = UTS.arrayFind(this.genderOptions, opt => { return opt.value === gender; });\n            return option ? option.label : '未知';\n        },\n        formatDate(timestamp = null) {\n            if (!timestamp)\n                return '未知';\n            const date = new Date(timestamp);\n            return date.toLocaleDateString('zh-CN', {\n                year: 'numeric',\n                month: '2-digit',\n                day: '2-digit'\n            });\n        },\n        refreshUserInfo() {\n            this.fetchUserInfo();\n        },\n        logout() {\n            uni.showModal(new UTSJSONObject({\n                title: '确认退出',\n                content: '确定要退出登录吗？',\n                success: (res) => { return __awaiter(this, void 0, void 0, function* () {\n                    if (res.confirm) {\n                        try {\n                            yield uniCloud.callFunction({\n                                name: 'user-api',\n                                data: new UTSJSONObject({ action: 'logout' })\n                            });\n                        }\n                        catch (err) {\n                            uni.__f__('warn', 'at pages/user/profile/profile.uvue:284', '登出接口调用失败（可忽略）:', err);\n                        }\n                        finally {\n                            uni.removeStorageSync('uni_id_token');\n                            uni.removeStorageSync('user_info');\n                            uni.redirectTo({ url: '/pages/user/login/login' });\n                        }\n                    }\n                }); }\n            }));\n        }\n    }\n});\n//# sourceMappingURL=D:/HBuilder-code/-/pages/user/profile/profile.uvue?vue&type=script&lang.uts.js.map","references":[],"uniExtApis":["uni.getStorageSync","uni.__f__","uniCloud.callFunction","uni.showToast","uni.stopPullDownRefresh","uni.removeStorageSync","uni.redirectTo","uni.showModal"],"map":"{\"version\":3,\"file\":\"profile.uvue?vue&type=script&lang.uts.js\",\"sourceRoot\":\"\",\"sources\":[\"profile.uvue?vue&type=script&lang.uts\"],\"names\":[],\"mappings\":\"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\"}"}
