{"version":3,"file":"profile.js","sources":["pages/user/profile/profile.uvue","../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvdXNlci9wcm9maWxlL3Byb2ZpbGUudXZ1ZQ"],"sourcesContent":["<template>\n  <view class=\"container\">\n    <!-- 加载状态 -->\n    <view v-if=\"loading\" class=\"loading-section\">\n      <text>加载中...</text>\n    </view>\n\n    <!-- 用户信息展示区 -->\n    <view v-else class=\"info-section\">\n      <!-- <image :src=\"userInfo.avatar || defaultAvatar\" class=\"avatar\" mode=\"aspectFill\"></image> -->\n\n      <view class=\"field\">\n        <text class=\"label\">用户ID：</text>\n        <text class=\"value\">{{ userInfo._id }}</text>\n      </view>\n\n      <view class=\"field\">\n        <text class=\"label\">用户名：</text>\n        <text class=\"value\">{{ userInfo.username }}</text>\n      </view>\n\n      <view class=\"field\">\n        <text class=\"label\">昵称：</text>\n        <input\n          class=\"nickname-input\"\n          type=\"text\"\n          v-model=\"userInfo.nickname\"\n          @blur=\"updateNickname\"\n          placeholder=\"点击修改昵称\"\n          :disabled=\"isUpdating\"\n        />\n        <text v-if=\"isUpdating\" class=\"updating-text\">更新中...</text>\n      </view>\n\n      <view class=\"field\">\n        <text class=\"label\">性别：</text>\n        <picker\n          class=\"gender-picker\"\n          :value=\"getCurrentGenderIndex\"\n          :range=\"genderOptions\"\n          range-key=\"label\"\n          @change=\"onGenderChange\"\n          :disabled=\"isUpdating\"\n        >\n          <text class=\"picker-text\">{{ getGenderLabel(userInfo.gender) }}</text>\n        </picker>\n      </view>\n\n      <view class=\"field\" v-if=\"userInfo.email\">\n        <text class=\"label\">邮箱：</text>\n        <text class=\"value\">{{ userInfo.email }}</text>\n      </view>\n\n      <view class=\"field\" v-if=\"userInfo.mobile\">\n        <text class=\"label\">手机号：</text>\n        <text class=\"value\">{{ userInfo.mobile }}</text>\n      </view>\n\n      <view class=\"field\">\n        <text class=\"label\">注册时间：</text>\n        <text class=\"value\">{{ formatDate(userInfo.register_date) }}</text>\n      </view>\n\n      <!-- 用户统计数据 -->\r\n\t  <!--\n      <view class=\"stats-section\">\n        <view class=\"stat-item\">\n          <text class=\"stat-number\">{{ userStats.content_count || 0 }}</text>\n          <text class=\"stat-label\">发布</text>\n        </view>\n        <view class=\"stat-item\">\n          <text class=\"stat-number\">{{ userStats.comment_count || 0 }}</text>\n          <text class=\"stat-label\">评论</text>\n        </view>\n        <view class=\"stat-item\">\n          <text class=\"stat-number\">{{ userStats.like_count || 0 }}</text>\n          <text class=\"stat-label\">点赞</text>\n        </view>\n      </view>\r\n\t  -->\n    </view>\n\n    <!-- 操作按钮区 -->\n    <view class=\"action-section\">\n      <button class=\"btn-action\" @click=\"refreshUserInfo\" :disabled=\"loading\">\n        刷新信息\n      </button>\n      \n      <navigator url=\"/pages/user/change-password/change-password\" class=\"btn-action\">\n        修改密码\n      </navigator>\n      \n      <button class=\"btn-logout\" @click=\"logout\">\n        退出登录\n      </button>\n    </view>\n  </view>\n</template>\n\n<script lang=\"uts\">\nexport default {\n  data() {\n    return {\n      userInfo: {\n        _id: '',\n        username: '',\n        nickname: '',\n        avatar: '',\n        gender: 0,\n        email: '',\n        mobile: '',\n        register_date: ''\n      },\n      userStats: {\n        content_count: 0,\n        comment_count: 0,\n        like_count: 0\n      },\n      loading: true,\n      isUpdating: false,\n      defaultAvatar: 'https://ruangong-dazuoye-file.oss-cn-shenzhen.aliyuncs.com/%E9%AB%98%E9%9B%85%E4%BC%81%E9%B9%85.jpg',\n      genderOptions: [\n        { value: 0, label: '未知' },\n        { value: 1, label: '男' },\n        { value: 2, label: '女' }\n      ]\n    };\n  },\n\n  onLoad() {\r\n\tconst token = uni.getStorageSync('uni_id_token');\r\n\tuni.__f__('log','at pages/user/profile/profile.uvue:132','【当前 token】:', JSON.stringify(token)); // 用 JSON.stringify 看清结构\n    this.fetchUserInfo();\n  },\n\n  onPullDownRefresh() {\n    this.fetchUserInfo();\n  },\n\n  computed: {\n    // 用于 picker 的当前索引（解决 picker value 必须是 index 的问题）\n    getCurrentGenderIndex() {\n      const index = this.genderOptions.findIndex(opt => opt.value === this.userInfo.gender);\n      return index === -1 ? 0 : index;\n    }\n  },\n\n  methods: {\n    async fetchUserInfo() {\n      this.loading = true;\n      try {\n        const res = await uniCloud.callFunction({\n          name: 'user-api',\n          data: {\n            action: 'get_profile'\n          }\n        });\n\n        const result = res.result || {};\n        if (result.code === 200 && result.data) {\n          const data = result.data;\n\n          // 分离 userInfo 和 stats（假设后端返回 { profile: {...}, stats: {...} } 或直接合并）\n          // 这里兼容两种结构：1. data 是完整用户对象；2. data = { profile, stats }\n          if (data.profile) {\n            this.userInfo = { ...data.profile };\n            this.userStats = { ...data.stats } || {};\n          } else {\n            // 假设 data 就是用户对象，stats 需单独处理（若无则保持默认0）\n            this.userInfo = { ...data };\n            // 如果后端未返回 stats，则保持原有默认值（0）\n          }\n\n          if (!this.userInfo.avatar) {\n            this.userInfo.avatar = this.defaultAvatar;\n          }\n        } else {\n          throw new Error(result.message || '获取用户信息失败');\n        }\n      } catch (err) {\n        uni.__f__('error','at pages/user/profile/profile.uvue:181','获取用户信息异常:', err);\n        uni.showToast({\n          title: '获取信息失败，请重试',\n          icon: 'none',\n          duration: 2000\n        });\n      } finally {\n        this.loading = false;\n        uni.stopPullDownRefresh();\n      }\n    },\n\n    async updateNickname() {\n      const newNickname = (this.userInfo.nickname || '').trim();\n      if (!newNickname) {\n        uni.showToast({ title: '昵称不能为空', icon: 'none' });\n        return;\n      }\n\n      this.isUpdating = true;\n      try {\n        const res = await uniCloud.callFunction({\n          name: 'user-api',\n          data: {\n            action: 'profile',\n            nickname: newNickname\n          }\n        });\n\n        const result = res.result || {};\n        if (result.code === 0) {\n          uni.showToast({ title: '昵称更新成功', icon: 'success' });\n        } else {\n          uni.showToast({ title: result.message || '更新失败', icon: 'none' });\n        }\n      } catch (err) {\n        uni.__f__('error','at pages/user/profile/profile.uvue:217','更新昵称失败:', err);\n        uni.showToast({ title: '网络错误，请重试', icon: 'none' });\n      } finally {\n        this.isUpdating = false;\n      }\n    },\n\n    async onGenderChange(e) {\n      const selectedIndex = e.detail.value;\n      const newGender = this.genderOptions[selectedIndex].value;\n\n      if (newGender === this.userInfo.gender) return;\n\n      this.isUpdating = true;\n      try {\n        const res = await uniCloud.callFunction({\n          name: 'user-api',\n          data: {\n            action: 'update_profile',\n            gender: newGender\n          }\n        });\n\n        const result = res.result || {};\n        if (result.code === 0) {\n          this.userInfo.gender = newGender;\n          uni.showToast({ title: '性别更新成功', icon: 'success' });\n        } else {\n          uni.showToast({ title: result.message || '更新失败', icon: 'none' });\n        }\n      } catch (err) {\n        uni.__f__('error','at pages/user/profile/profile.uvue:248','更新性别失败:', err);\n        uni.showToast({ title: '网络错误，请重试', icon: 'none' });\n      } finally {\n        this.isUpdating = false;\n      }\n    },\n\n    getGenderLabel(gender) {\n      const option = this.genderOptions.find(opt => opt.value === gender);\n      return option ? option.label : '未知';\n    },\n\n    formatDate(timestamp) {\n      if (!timestamp) return '未知';\n      const date = new Date(timestamp);\n      return date.toLocaleDateString('zh-CN', {\n        year: 'numeric',\n        month: '2-digit',\n        day: '2-digit'\n      });\n    },\n\n    refreshUserInfo() {\n      this.fetchUserInfo();\n    },\n\n    logout() {\n      uni.showModal({\n        title: '确认退出',\n        content: '确定要退出登录吗？',\n        success: async (res) => {\n          if (res.confirm) {\n            try {\n              await uniCloud.callFunction({\n                name: 'user-api',\n                data: { action: 'logout' }\n              });\n            } catch (err) {\n              uni.__f__('warn','at pages/user/profile/profile.uvue:286','登出接口调用失败（可忽略）:', err);\n            } finally {\n              uni.removeStorageSync('uni_id_token');\n              uni.removeStorageSync('user_info');\n              uni.redirectTo({ url: '/pages/user/login/login' });\n            }\n          }\n        }\n      });\n    }\n  }\n};\n</script>\n\n<style scoped>\n/* 你的原样式完全保留，此处省略以节省篇幅 */\n.container {\n  padding: 40rpx 30rpx;\n  background-color: #f8f9fa;\n  min-height: 100vh;\n}\n\n.loading-section {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  height: 300rpx;\n  font-size: 32rpx;\n  color: #666;\n}\n\n.info-section {\n  background: white;\n  border-radius: 30rpx;\n  padding: 50rpx 40rpx;\n  margin-bottom: 30rpx;\n  box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.05);\n  text-align: center;\n}\n\n.avatar {\n  width: 160rpx;\n  height: 160rpx;\n  border-radius: 50%;\n  margin-bottom: 40rpx;\n  object-fit: cover;\n  border: 4rpx solid #f0f0f0;\n}\n\n.field {\n  display: flex;\n  justify-content: flex-start;\n  align-items: center;\n  margin: 25rpx 0;\n  padding: 0 20rpx;\n  min-height: 60rpx;\n}\n\n.label {\n  font-size: 30rpx;\n  color: #555;\n  min-width: 140rpx;\n  text-align: left;\n  font-weight: 500;\n}\n\n.value {\n  font-size: 30rpx;\n  color: #333;\n  flex: 1;\n  text-align: left;\n  word-break: break-all;\n}\n\n.nickname-input {\n  font-size: 30rpx;\n  color: #333;\n  flex: 1;\n  text-align: left;\n  padding: 10rpx 0;\n  border-bottom: 1rpx solid #eee;\n  background: transparent;\n  outline: none;\n}\n\n.nickname-input:disabled {\n  color: #999;\n  background-color: #f9f9f9;\n}\n\n.updating-text {\n  font-size: 26rpx;\n  color: #999;\n  margin-left: 20rpx;\n}\n\n.gender-picker {\n  flex: 1;\n  text-align: left;\n}\n\n.picker-text {\n  font-size: 30rpx;\n  color: #333;\n  padding: 10rpx 0;\n  border-bottom: 1rpx solid #eee;\n}\n\n.stats-section {\n  display: flex;\n  justify-content: space-around;\n  margin-top: 50rpx;\n  padding-top: 40rpx;\n  border-top: 1rpx solid #f0f0f0;\n}\n\n.stat-item {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n}\n\n.stat-number {\n  font-size: 40rpx;\n  font-weight: bold;\n  color: #007aff;\n  margin-bottom: 10rpx;\n}\n\n.stat-label {\n  font-size: 26rpx;\n  color: #666;\n}\n\n.action-section {\n  background: white;\n  border-radius: 30rpx;\n  padding: 40rpx 30rpx;\n  box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.05);\n}\n\n.btn-action {\n  display: block;\n  width: 100%;\n  padding: 25rpx;\n  background-color: #007aff;\n  color: white;\n  border-radius: 25rpx;\n  font-size: 32rpx;\n  text-align: center;\n  margin-bottom: 30rpx;\n  border: none;\n  outline: none;\n}\n\n.btn-action:disabled {\n  background-color: #cccccc;\n  color: #666666;\n}\n\n.btn-action:not(:disabled):active {\n  opacity: 0.8;\n}\n\n.btn-logout {\n  display: block;\n  width: 100%;\n  padding: 25rpx;\n  background-color: #ff3b30;\n  color: white;\n  border-radius: 25rpx;\n  font-size: 32rpx;\n  text-align: center;\n  border: none;\n  outline: none;\n}\n\n.btn-logout:active {\n  opacity: 0.8;\n}\n\n@media (max-width: 750rpx) {\n  .container {\n    padding: 30rpx 20rpx;\n  }\n  .info-section {\n    padding: 40rpx 30rpx;\n  }\n  .avatar {\n    width: 140rpx;\n    height: 140rpx;\n  }\n  .label {\n    font-size: 28rpx;\n    min-width: 120rpx;\n  }\n  .value, .nickname-input, .picker-text {\n    font-size: 28rpx;\n  }\n  .stat-number {\n    font-size: 36rpx;\n  }\n  .stat-label {\n    font-size: 24rpx;\n  }\n  .btn-action, .btn-logout {\n    font-size: 30rpx;\n    padding: 22rpx;\n  }\n}\n</style>","import MiniProgramPage from 'D:/软工大作业/小程序界面/pages/user/profile/profile.uvue'\nwx.createPage(MiniProgramPage)"],"names":["defineComponent","uni","uniCloud","__awaiter"],"mappings":"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"}