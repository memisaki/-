{"version":3,"file":"upload.js","sources":["pages/comtent/upload/upload.uvue","../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY29tdGVudC91cGxvYWQvdXBsb2FkLnV2dWU"],"sourcesContent":["<template>\n  <view class=\"upload-container\">\n    <!-- 标题 -->\n    <view class=\"form-item\">\n      <text class=\"label\">标题 *</text>\n      <input\n        v-model=\"formData.title\"\n        placeholder=\"请输入标题（最多30字）\"\n        maxlength=\"30\"\n        class=\"input\"\n      />\n    </view>\n\n    <!-- 描述 -->\n    <view class=\"form-item\">\n      <text class=\"label\">描述（可选）</text>\n      <textarea\n        v-model=\"formData.description\"\n        placeholder=\"请输入描述文字...\"\n        maxlength=\"500\"\n        class=\"textarea\"\n      />\n    </view>\n\n    <!-- 标签 -->\n    <view class=\"form-item\">\n      <text class=\"label\">标签（逗号分隔）</text>\n      <input\n        v-model=\"rawTags\"\n        placeholder=\"如：美食,旅行,日常\"\n        class=\"input\"\n      />\n    </view>\n\n    <!-- 内容类型选择 -->\n    <view class=\"form-item\">\n      <text class=\"label\">内容类型 *</text>\n      <view class=\"type-selector\">\n        <button\n          :class=\"{ active: formData.type === 'text' }\"\n          @click=\"setContentType('text')\"\n        >\n          纯文本\n        </button>\n        <button\n          :class=\"{ active: formData.type === 'image' }\"\n          @click=\"setContentType('image')\"\n        >\n          图片\n        </button>\n        <button\n          :class=\"{ active: formData.type === 'video' }\"\n          @click=\"setContentType('video')\"\n        >\n          视频\n        </button>\n      </view>\n    </view>\n\n    <!-- 媒体上传区域 -->\n    <view v-if=\"formData.type !== 'text'\" class=\"media-upload\">\n      <button @click=\"selectMedia\" class=\"upload-btn\">\n        {{ formData.type === 'image' ? '选择图片' : '选择视频' }}\n      </button>\n\n      <!-- 预览 -->\n      <view v-if=\"previewUrl\" class=\"preview\">\n        <image\n          v-if=\"formData.type === 'image'\"\n          :src=\"previewUrl\"\n          mode=\"aspectFit\"\n          class=\"preview-media\"\n        />\n        <video\n          v-else-if=\"formData.type === 'video'\"\n          :src=\"previewUrl\"\n          controls\n          class=\"preview-media\"\n        ></video>\n      </view>\n\n      <text v-if=\"mediaError\" class=\"error\">{{ mediaError }}</text>\n    </view>\n\n    <!-- 提交按钮 -->\n    <button @click=\"submitPost\" :disabled=\"isSubmitting\" class=\"submit-btn\">\n      {{ isSubmitting ? '发布中...' : '发布内容' }}\n    </button>\n  </view>\n</template>\n\n<script setup lang=\"uts\">\nconst formData = ref({\n  title: '',\n  description: '',\n  type: 'text',\n  mediaLocalPath: '',\n  tags: [] as string[]\n})\n\nconst rawTags = ref('')\nconst previewUrl = ref('')\nconst mediaError = ref('')\nconst isSubmitting = ref(false)\n\n// 自动处理标签（最多5个，去重）\nwatch(() => rawTags.value, (newVal) => {\n  if (!newVal) {\n    formData.value.tags = []\n    return\n  }\n  const tags = newVal\n    .split(',')\n    .map(t => t.trim())\n    .filter(t => t)\n    .slice(0, 5)\n  formData.value.tags = [...new Set(tags)]\n})\n\nfunction setContentType(type: string) {\n  formData.value.type = type\n  formData.value.mediaLocalPath = ''\n  previewUrl.value = ''\n  mediaError.value = ''\n}\n\nasync function selectMedia() {\n  try {\n    mediaError.value = ''\n\n    if (formData.value.type === 'image') {\n      const res = await uni.chooseImage({ count: 1, sizeType: ['compressed'] })\n      if (res.tempFilePaths.length === 0) return\n      const tempPath = res.tempFilePaths[0]\n      previewUrl.value = tempPath\n      formData.value.mediaLocalPath = tempPath\n\n    } else if (formData.value.type === 'video') {\n      const res = await uni.chooseVideo({ maxDuration: 60, camera: 'back' })\n      if (res.duration > 60) {\n        mediaError.value = '视频时长不能超过60秒'\n        return\n      }\n      previewUrl.value = res.tempFilePath\n      formData.value.mediaLocalPath = res.tempFilePath\n    }\n  } catch (err) {\n    uni.__f__('error','at pages/comtent/upload/upload.uvue:148','选择媒体失败:', err)\n    mediaError.value = '选择失败，请重试'\n  }\n}\n\n// 上传到阿里云\nasync function uploadToAliyun(localPath: string, fileType: string): Promise<string> {\n  const timestamp = Date.now()\n  const extMatch = localPath.match(/\\.([^.]+)$/i)\n  const ext = extMatch ? extMatch[1].toLowerCase() : (fileType === 'image' ? 'jpg' : 'mp4')\n  const userId = 'user' // 可替换为真实 user_id，但不影响路径唯一性\n  const cloudPath = `posts/${fileType}/${userId}_${timestamp}.${ext}`\n\n  try {\n    const res = await uniCloud.uploadFile({\n      filePath: localPath,\n      cloudPath: cloudPath,\n      onUploadProgress(progressEvent) {\n        const percent = Math.round((progressEvent.loaded * 100) / progressEvent.total)\n        uni.__f__('log','at pages/comtent/upload/upload.uvue:167','上传进度:', percent + '%')\n      }\n    })\n\n    if (res.fileID) {\n      return res.fileID\n    } else {\n      throw new Error(res.errorMessage || '上传失败')\n    }\n  } catch (err) {\n    uni.__f__('error','at pages/comtent/upload/upload.uvue:177','上传失败:', err)\n    throw new Error('网络错误，请重试')\n  }\n}\n\n// 获取当前用户 _id（兼容两种存储结构）\nfunction getCurrentUserId() {\n  const rawStorage = uni.getStorageSync('user_info')\n  const user_info = rawStorage?.userInfo || rawStorage || {}\n  uni.__f__('log','at pages/comtent/upload/upload.uvue:186','【upload 页面】user_info:', user_info)\n  uni.__f__('log','at pages/comtent/upload/upload.uvue:187','【upload 页面】_id:', user_info?._id)\n  return user_info?._id || ''\n}\n\n// 正式提交内容\nasync function submitPost() {\n  if (!formData.value.title.trim()) {\n    uni.showToast({ title: '请输入标题', icon: 'none' })\n    return\n  }\n\n  if (formData.value.type !== 'text' && !formData.value.mediaLocalPath) {\n    uni.showToast({ title: '请上传媒体文件', icon: 'none' })\n    return\n  }\n\n  isSubmitting.value = true\n\n  try {\n    const userId = getCurrentUserId()\n    if (!userId) {\n      uni.showToast({ title: '请先登录', icon: 'none' })\n      return\n    }\n\n    let mediaFiles = []\n\n    if (formData.value.type !== 'text') {\n      const mediaUrl = await uploadToAliyun(formData.value.mediaLocalPath, formData.value.type)\n\n      let fileType = 'application/octet-stream'\n      if (formData.value.type === 'image') {\n        fileType = mediaUrl.toLowerCase().endsWith('.png') ? 'image/png' : 'image/jpeg'\n      } else if (formData.value.type === 'video') {\n        fileType = 'video/mp4'\n      }\n\n      mediaFiles = [{ url: mediaUrl, file_type: fileType }]\n    }\n\n    // 构造请求数据（注意字段名匹配 content-api 期望）\n    const payload = {\n      action: 'create',\n      title: formData.value.title.trim(),\n      text_content: formData.value.description.trim(), // 注意：不是 description\n      content_type: formData.value.type,\n      tags: formData.value.tags,\n      user_id: userId,\n      media_files: mediaFiles\n    }\n\n    // 调用 content-api 云函数\n    const res = await uniCloud.callFunction({\n      name: 'content-api',\n      data: payload,\n      env: 'cloud'\n    })\n\n    if (res.result?.code === 200) {\n      uni.showToast({ title: '发布成功！', icon: 'success' })\n      setTimeout(() => uni.navigateBack(), 1500)\n    } else {\n      throw new Error(res.result?.message || '发布失败')\n    }\n\n  } catch (err: any) {\n    uni.__f__('error','at pages/comtent/upload/upload.uvue:253','发布失败:', err)\n    uni.showToast({ title: err.message || '发布失败，请重试', icon: 'none' })\n  } finally {\n    isSubmitting.value = false\n  }\n}\n</script>\n\n<style scoped>\n.upload-container {\n  padding: 120rpx 30rpx 30rpx;\n  background-color: #f8f9fa;\n  min-height: 100vh;\n}\n\n.form-item {\n  margin-bottom: 40rpx;\n}\n\n.label {\n  display: block;\n  font-size: 28rpx;\n  color: #333;\n  margin-bottom: 16rpx;\n  font-weight: bold;\n}\n\n.input {\n  width: 100%;\n  padding: 10rpx;\n  border: 1rpx solid #ddd;\n  border-radius: 12rpx;\n  font-size: 28rpx;\n  background: white;\n}\n\n.textarea {\n  width: 100%;\n  height: 200rpx;\n  padding: 20rpx;\n  border: 1rpx solid #ddd;\n  border-radius: 12rpx;\n  font-size: 28rpx;\n  background: white;\n  line-height: 1.5;\n}\n\n.type-selector {\n  display: flex;\n  gap: 20rpx;\n}\n\n.type-selector button {\n  flex: 1;\n  padding: 16rpx 0;\n  font-size: 26rpx;\n  background-color: #f0f0f0;\n  color: #333;\n  border-radius: 12rpx;\n}\n\n.type-selector button.active {\n  background-color: #007aff;\n  color: white;\n}\n\n.media-upload {\n  margin-top: 20rpx;\n}\n\n.upload-btn {\n  background-color: #007aff;\n  color: white;\n  padding: 20rpx;\n  border-radius: 12rpx;\n  font-size: 28rpx;\n}\n\n.preview {\n  margin-top: 20rpx;\n  text-align: center;\n}\n\n.preview-media {\n  width: 100%;\n  height: 400rpx;\n  background-color: #eee;\n  border-radius: 12rpx;\n}\n\n.error {\n  color: red;\n  font-size: 24rpx;\n  margin-top: 10rpx;\n  display: block;\n}\n\n.submit-btn {\n  width: 100%;\n  padding: 24rpx;\n  background-color: #007aff;\n  color: white;\n  font-size: 32rpx;\n  border-radius: 16rpx;\n  margin-top: 60rpx;\n}\n\n.submit-btn:disabled {\n  background-color: #ccc;\n}\n</style>","import MiniProgramPage from 'D:/软工大作业/小程序界面/pages/comtent/upload/upload.uvue'\nwx.createPage(MiniProgramPage)"],"names":["ref","watch","uni","uniCloud"],"mappings":"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"}